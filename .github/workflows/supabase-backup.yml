name: Daily Supabase Backup

on:
  schedule:
    - cron: '0 0 * * *' # Midnight every day
  workflow_dispatch: # Allows manual trigger from the Actions tab

jobs:
  backup:
    name: Backup Supabase Database
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Run Database Dump
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          # Create a backup directory
          mkdir -p backups

          # Link the project (required for newer CLI versions)
          supabase link --project-ref "$PROJECT_ID" -p "$DB_PASSWORD"
          
          # 1. Dump Roles
          supabase db dump -p "$DB_PASSWORD" --role-only -f backups/roles.sql
          
          # 2. Dump Schema
          supabase db dump -p "$DB_PASSWORD" --schema-only -f backups/schema.sql
          
          # 3. Dump Data (The important stuff)
          supabase db dump -p "$DB_PASSWORD" --data-only -f backups/data.sql
          
          # Compress the backups
          tar -czvf "supabase_backup_$(date +%Y%m%d_%H%M%S).tar.gz" backups/

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: supabase-db-backup
          path: supabase_backup_*.tar.gz
          retention-days: 7 # GitHub Free Tier storage limit for artifacts

      # Optional: To store backups permanently in a private branch:
      # - name: Commit Backup
      #   run: |
      #     git config --local user.email "action@github.com"
      #     git config --local user.name "GitHub Action"
      #     git checkout -b backups
      #     git add supabase_backup_*.tar.gz
      #     git commit -m "Daily backup $(date +%F)"
      #     git push origin backups
